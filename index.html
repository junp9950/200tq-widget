<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>티큐 200일선 매매법 - Web 위젯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
    }
    .title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .sub { font-size: 12px; color: #aaa; margin-bottom: 12px; }
    .stat-line { font-size: 14px; margin: 4px 0; }
    .situation { font-size: 16px; margin-top: 12px; }
    .principle-line { font-size: 18px; font-weight: 700; }
    .maintain { color: #b96bc6; }
    .buy { color: #fd8a69; }
    .sell { color: #58ccff; }
    .price { color: #58ccff; }
    .env { color: #b96bc6; }
    .ma { color: #AFD485; }
  </style>
</head>
<body>
  <div class="title">티큐 200일선 매매법</div>
  <div class="sub" id="meta-info">로딩 중...</div>

  <div id="principles"></div>

  <div class="situation" id="situation"></div>

  <div class="stat-line" id="stats"></div>

  <script>
    const ENVELOPE_PERCENTAGE = 5;

    async function loadData() {
      // data/tqqq-raw.json을 읽어옴. URL에 타임스탬프를 붙여 캐싱 방지
      const res = await fetch('data/tqqq-raw.json?' + Date.now());
      if (!res.ok) {
        document.getElementById('meta-info').textContent = '데이터 로딩 실패';
        return;
      }
      const json = await res.json();
      const result = json.chart.result[0];
      const timestamps = result.timestamp;
      let closes = result.indicators.quote[0].close.map(p => p === null ? 0 : p);
      const currentPrice = result.meta.regularMarketPrice;
      // 가장 마지막 종가(null일 수 있음)를 현재가로 업데이트
      if (closes.length > 0) closes[closes.length - 1] = currentPrice;

      // 200일선 계산
      const len = closes.length;
      if (len < 200) {
        document.getElementById('meta-info').textContent = '데이터 부족: 200일 미만';
        return;
      }

      // 마지막 200일의 종가 합계
      let sum = 0;
      for (let i = len - 200; i < len; i++) sum += closes[i];
      const ma200 = sum / 200;
      const envelope = ma200 * (1 + ENVELOPE_PERCENTAGE / 100);

      const curr = closes[len - 1]; // 현재 종가
      const yest = closes[len - 2]; // 전일 종가

      // 상황 판별 로직
      let situationName = '하락 상황';
      let principle = 'SPYM TQQQ 매도\nSGOV 매수';

      const envelopeNow = envelope;

      if (curr > ma200 && yest <= ma200) {
        situationName = '상승 신호!';
        principle = '내일 종가 확인\n이후 진입';
      } else if (curr > envelopeNow) {
        situationName = '과열 상황';
        principle = 'TQQQ 유지\nSPYM 추가매수';
      } else if (curr > ma200) {
        situationName = '집중 투자 상황';
        principle = 'SGOV 매도\nTQQQ 매수';
      }

      const deviation = ((curr / ma200) - 1) * 100;

      // 날짜 포맷 (NY 종가 기준 시간대 반영)
      const lastTs = timestamps[timestamps.length - 1] * 1000;
      const nyDate = new Date(lastTs);
      const formatter = new Intl.DateTimeFormat('ko-KR', {
        year: '2-digit',
        month: '2-digit',
        day: '2-digit',
        timeZone: 'America/New_York'
      });
      document.getElementById('meta-info').textContent =
        formatter.format(nyDate) + ' 종가 기준';

      // 행동 원칙 출력
      const principlesDiv = document.getElementById('principles');
      principlesDiv.innerHTML = '';
      const lines = principle.split('\n');

      function colorizeWord(word) {
        if (word.includes('유지')) return 'maintain';
        if (word.includes('매수') || word.includes('추가매수')) return 'buy';
        if (word.includes('매도')) return 'sell';
        return '';
      }

      lines.forEach(line => {
        const div = document.createElement('div');
        div.className = 'principle-line';
        line.split(' ').forEach((word, idx, arr) => {
          const span = document.createElement('span');
          const cls = colorizeWord(word);
          if (cls) span.classList.add(cls);
          span.textContent = word;
          div.appendChild(span);
          if (idx < arr.length - 1) div.appendChild(document.createTextNode(' '));
        });
        principlesDiv.appendChild(div);
      });

      // 상황 + 괴리율
      const situationText =
        `${situationName} (${deviation >= 0 ? '+' : ''}${deviation.toFixed(2)}%)`;
      document.getElementById('situation').textContent = situationText;

      // 핵심 지표 라인
      document.getElementById('stats').innerHTML =
        `<span class="price">$${curr.toFixed(2)}</span> / ` +
        `<span class="env">$${envelopeNow.toFixed(2)}</span> / ` +
        `<span class="ma">$${ma200.toFixed(2)}</span>`;
    }

    loadData().catch(err => {
      console.error(err);
      document.getElementById('meta-info').textContent = '오류 발생';
    });
  </script>
</body>
</html>