# .github/workflows/fetch-tqqq.yml
name: Fetch TQQQ Data

on:
  schedule:
    # 매일 09:10 UTC에 실행 (한국 시간 대략 오후 6시 10분)
    - cron: '10 9 * * *'
  # 수동으로 실행하고 싶을 때 GitHub Actions 탭에서 버튼 클릭 가능
  workflow_dispatch: {}

permissions:
  # 데이터 파일 커밋/푸시를 위해 이 권한이 반드시 필요합니다.
  contents: write

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create data directory if not exists
        run: mkdir -p data

      - name: Fetch TQQQ chart JSON
        run: |
          # --user-agent 옵션을 추가하여 브라우저처럼 보이게 만듭니다.
          curl -s \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36" \
            "https://query1.finance.yahoo.com/v8/finance/chart/TQQQ?range=300d&interval=1d" \
            -o data/tqqq-raw.json

      - name: Commit and push if changed
        env:
          # GitHub Actions가 기본으로 제공하는 토큰 사용
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        run: |
          # 커밋할 사용자 정보 설정
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 데이터 파일 추가
          git add data/tqqq-raw.json

          # 변경 사항이 있는지 확인 후, 변경된 경우에만 커밋/푸시 진행
          if git diff --cached --quiet; then
            echo "No changes in TQQQ data. Skipping commit."
          else
            git commit -m "chore: update TQQQ data"
            git push
          fi